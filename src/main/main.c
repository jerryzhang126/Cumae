/*
 * Main Cumae source file.
 */
#include <stdio.h>
#include <avr/interrupt.h>

#include <cumae/base.h>
#include <cumae/display.h>

/*
 * SW_PAGE_INT handler.
 */
ISR(INT0_vect, ISR_BLOCK)
{
    printf("SW_PAGE_INT!\r\n");
}

int main()
{
    cumae_usart_init();

    printf("\r\n*** Cumae %s.\r\n", CUMAE_VERSION);
    printf("*** Copyright (c) 2016 Michelangelo De Simone <michel@ngelo.eu>\r\n\r\n");

    /* STATUS_LED (PB1) as output, ON for OK. */
    DDRB |= 1 << PB1; //0x2;
    PORTB |= 1 << PB1;

    /* Enable interrupts on INT0 on rising signal. */
    EIMSK = 0x1;
    EICRA = 0x3;
    sei();

    /* Display power up sequence. */
    cumae_display_power_up();

    uint8_t alternate_black[] = {
        /* 1..16 Data */
        0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 

        /* 24 bytes of scan */
        0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 
        0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 0xF, 
        0xF, 0xF, 0xF, 0xF,
#if 0
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
#endif

        /* 17..32 Data */
        0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x00
    };

    uint8_t all_white[] = {
        /* Odd DB (white). */
        0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 
        0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 

        /* Scan Byte (scan on everywhere). */
#if 0
        0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 
        0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 
        0xF0, 0xF0, 0xF0, 0xF0,
#endif
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
        0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 

        /* Even DB (white). */
        0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 
        0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 

        0x00
    };

    cumae_display_send_data(0x0A, all_white, 73);
    cumae_display_send_command(0x02, 0x07);

    cumae_delay_ms(5000);

    cumae_display_send_data(0x0A, alternate_black, 73);
    cumae_display_send_command(0x02, 0x07);

    cumae_delay_ms(480);
    cumae_display_power_off();

    /* Idle loop - Don't put anything here.:) */
    while(1) {
    }

    return 0;
}
